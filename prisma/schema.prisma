generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ATHLETE
  PARENT
  COACH
  ADMIN
}

enum ProcessingStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum CompressionStatus {
  NOT_REQUIRED
  PENDING
  COMPRESSED
  FAILED
}

enum ReportStatus {
  OPEN
  IN_REVIEW
  RESOLVED
  DISMISSED
}

enum ExportStatus {
  REQUESTED
  READY
  FAILED
}

model User {
  id                    String    @id @default(cuid())
  name                  String?
  email                 String    @unique
  emailVerified         DateTime?
  passwordHash          String
  role                  Role      @default(ATHLETE)
  age                   Int?
  position              String?
  team                  String?
  competitionLevel      String?
  gender                String?
  parentEmail           String?
  parentConsentVerified Boolean   @default(false)
  shareInBenchmarks     Boolean   @default(true)
  anonymizeForBenchmark Boolean   @default(true)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  deletedAt             DateTime?

  accounts           Account[]
  sessions           Session[]
  submissions        DrillSubmission[]
  benchmarkSnapshots BenchmarkSnapshot[]
  consentLogs        ConsentLog[]        @relation("ConsentTarget")
  consentActions     ConsentLog[]        @relation("ConsentActor")
  reportsFiled       UserReport[]        @relation("ReportReporter")
  reportsReviewed    UserReport[]        @relation("ReportReviewer")
  manualOverrides    ManualOverride[]    @relation("OverrideAdmin")
  exportRequests     DataExportRequest[]

  @@index([role])
  @@index([age, position, competitionLevel])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model DrillDefinition {
  id                  String   @id @default(cuid())
  slug                String   @unique
  sport               String   @default("soccer")
  name                String
  description         String
  guidelines          String
  instructionVideoUrl String?
  metricPrimaryKey    String   @default("sprintTime")
  lowerIsBetter       Boolean  @default(true)
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  submissions DrillSubmission[]
  aggregates  BenchmarkAggregate[]

  @@index([sport, isActive])
}

model DrillSubmission {
  id                  String            @id @default(cuid())
  athleteId           String
  drillDefinitionId   String
  submittedAt         DateTime          @default(now())
  recordingDate       DateTime
  location            String
  drillType           String
  fileUrl             String?
  fileName            String
  fileSize            Int
  mimeType            String
  storageProvider     String?
  storageKey          String?
  videoHash           String?
  videoExpiresAt      DateTime?
  videoDeletedAt      DateTime?
  videoPurgeError     String?
  retainVideoForAudit Boolean           @default(false)
  compressionStatus   CompressionStatus @default(NOT_REQUIRED)
  uploadProgress      Int               @default(0)
  processingStatus    ProcessingStatus  @default(QUEUED)
  processingAttempts  Int               @default(0)
  lastError           String?
  frameRate           Float?
  startFrame          Int?
  finishFrame         Int?
  repetitionHint      Int?
  metadata            Json?
  queuedAt            DateTime          @default(now())
  startedAt           DateTime?
  completedAt         DateTime?

  athlete            User                @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  drillDefinition    DrillDefinition     @relation(fields: [drillDefinitionId], references: [id])
  metricResult       MetricResult?
  benchmarkSnapshots BenchmarkSnapshot[]
  processingLogs     ProcessingLog[]
  manualOverrides    ManualOverride[]
  userReports        UserReport[]

  @@index([athleteId, submittedAt])
  @@index([processingStatus, queuedAt])
  @@index([drillDefinitionId, submittedAt])
  @@index([videoDeletedAt, videoExpiresAt])
}

model MetricResult {
  id                           String   @id @default(cuid())
  submissionId                 String   @unique
  metricVersion                String
  sprintTime                   Float?
  accelerationTiming           Float?
  changeOfDirectionMeasurement Float?
  shotTiming                   Float?
  repetitionCount              Int?
  motionTrackingScore          Float?
  frameBasedDuration           Float?
  errorToleranceScore          Float?
  drillCompletionRate          Float?
  consistencyScore             Float?
  normalizedScore              Float?
  reliabilityScore             Float?
  createdAt                    DateTime @default(now())

  submission DrillSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([createdAt])
}

model BenchmarkSnapshot {
  id              String   @id @default(cuid())
  athleteId       String
  submissionId    String
  cohortKey       String
  percentile      Float
  relativeRank    Int
  normalizedScore Float
  distribution    Json
  isAnonymized    Boolean  @default(true)
  createdAt       DateTime @default(now())

  athlete    User            @relation(fields: [athleteId], references: [id], onDelete: Cascade)
  submission DrillSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([submissionId])
  @@index([cohortKey, createdAt])
  @@index([athleteId, createdAt])
}

model BenchmarkAggregate {
  id                String   @id @default(cuid())
  cohortKey         String
  drillDefinitionId String
  metricName        String
  sampleSize        Int
  mean              Float
  stdDev            Float
  p50               Float
  p90               Float
  lastRecalculated  DateTime @default(now())

  drillDefinition DrillDefinition @relation(fields: [drillDefinitionId], references: [id], onDelete: Cascade)

  @@unique([cohortKey, drillDefinitionId, metricName])
  @@index([cohortKey, lastRecalculated])
}

model ConsentLog {
  id          String   @id @default(cuid())
  userId      String
  actorUserId String?
  consentType String
  granted     Boolean
  notes       String?
  createdAt   DateTime @default(now())

  user  User  @relation("ConsentTarget", fields: [userId], references: [id], onDelete: Cascade)
  actor User? @relation("ConsentActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
}

model UserReport {
  id           String       @id @default(cuid())
  reporterId   String
  submissionId String?
  reason       String
  details      String?
  status       ReportStatus @default(OPEN)
  reviewedById String?
  reviewedAt   DateTime?
  createdAt    DateTime     @default(now())

  reporter   User             @relation("ReportReporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reviewedBy User?            @relation("ReportReviewer", fields: [reviewedById], references: [id], onDelete: SetNull)
  submission DrillSubmission? @relation(fields: [submissionId], references: [id], onDelete: SetNull)

  @@index([status, createdAt])
}

model ManualOverride {
  id           String   @id @default(cuid())
  submissionId String
  adminId      String
  action       String
  notes        String?
  payload      Json?
  createdAt    DateTime @default(now())

  submission DrillSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  admin      User            @relation("OverrideAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([submissionId, createdAt])
}

model ProcessingLog {
  id           String           @id @default(cuid())
  submissionId String
  status       ProcessingStatus
  message      String
  attempt      Int
  durationMs   Int?
  createdAt    DateTime         @default(now())

  submission DrillSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@index([submissionId, createdAt])
}

model SystemLog {
  id        String   @id @default(cuid())
  level     String
  category  String
  message   String
  metadata  Json?
  latencyMs Int?
  createdAt DateTime @default(now())

  @@index([category, createdAt])
  @@index([level, createdAt])
}

model ModelVersion {
  id        String   @id @default(cuid())
  version   String   @unique
  notes     String
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model RetrainingJob {
  id          String   @id @default(cuid())
  requestedBy String
  status      String   @default("QUEUED")
  notes       String?
  createdAt   DateTime @default(now())

  @@index([status, createdAt])
}

model BackupRecord {
  id        String   @id @default(cuid())
  location  String
  status    String
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model PositionTaxonomy {
  id        String   @id @default(cuid())
  sport     String   @default("soccer")
  code      String   @unique
  label     String
  createdAt DateTime @default(now())
}

model DataExportRequest {
  id          String       @id @default(cuid())
  userId      String
  status      ExportStatus @default(REQUESTED)
  requestedAt DateTime     @default(now())
  completedAt DateTime?
  exportUrl   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, requestedAt])
}
